// <auto-generated />
#nullable enable
using System;
using System.Collections.Generic;
using Game.CSV;
using UnityEngine;
#if UNITY_EDITOR
using UnityEditor;
#endif
namespace Game.Data.Definition.Machines {
public partial class BaseMachineSection : ICsvImportableConfig, ICsvExportableConfig, ICsvRemarkProvider
{
    public IReadOnlyList<string> GetExpectedColumns() => CsvBinding_BaseMachineDefinition.Header;
    public IReadOnlyList<string> GetCsvHeader() => CsvBinding_BaseMachineDefinition.Header;
    public IReadOnlyList<string> GetCsvRemarks() => CsvBinding_BaseMachineDefinition.Remarks;
    public void PrepareForCsvImport(bool clearExisting)
    {
#if UNITY_EDITOR
        if (clearExisting) definitions.Clear();
#endif
    }
    public bool ImportCsvRow(Dictionary<string,string> row, ICsvImportHelper helper, int lineIndex)
    {
#if UNITY_EDITOR
        try
        {
            if (!row.TryGetValue("id", out var idStr) || string.IsNullOrWhiteSpace(idStr) || !int.TryParse(idStr,out var idVal))
                return false;
            BaseMachineDefinition target = null;
            for (int i = 0; i < definitions.Count; i++)
            {
                var d = definitions[i].definition;
                if (d != null && d.Id == idVal) { target = d; break; }
            }
            if (target == null)
            {
                target = new BaseMachineDefinition();
                definitions.Add(new DefinitionItem{ definition = target, description = ""});
            }
            CsvBinding_BaseMachineDefinition.ImportInto(target, row, AssetCsvResolver.Instance, lineIndex);
            return true;
        }
        catch (Exception e)
        {
            helper.LogError(lineIndex, e.Message);
            return false;
        }
#else
        return false;
#endif
    }
    public void FinalizeCsvImport(int success, int error)
    {
#if UNITY_EDITOR
        definitions.Sort((a,b)=>
        {
            if (a?.definition == null || b?.definition == null) return 0;
            return a.definition.Id.CompareTo(b.definition.Id);
        });
        EditorUtility.SetDirty(this);
#endif
    }
    public IEnumerable<Dictionary<string,string>> ExportCsvRows()
    {
        foreach (var di in definitions)
        {
            if (di?.definition == null) continue;
            yield return CsvBinding_BaseMachineDefinition.Export(di.definition);
        }
    }
    /// <summary>
    /// 导出 CSV：第一行中文备注，第二行英文列名，后续为数据行。
    /// </summary>
    public void ExportCsv(string path, bool utf8Bom = true)
    {
        var header = CsvBinding_BaseMachineDefinition.Header;
        var remarks = CsvBinding_BaseMachineDefinition.Remarks;
        var rows = ExportCsvRows();
        CsvExportUtility.Write(path, header, rows, remarks, utf8Bom);
        Debug.Log($"[CSVGen] 导出完成: {path}");
    }
}
}
